# Razor Pages

## Connect with Database

### Part1

- Connect SQL Server Database under the `App_Data` directory

```CS
@using WebMatrix.Data

@{
    ViewBag.Title = "W11/Index";
}

@{
    var db = DataBase.Open("FeedbackDB");
    var st = Request.Form["searchText"];
    var vd = Request.Form["visitDate"];

    var sql = "SELECT * FROM Customers AS C " +
                "JOIN Feedback AS F ON C.customerID = F.customerID " +
                "WHERE name LIKE CONCAT('%', @0, '%') " +
                "AND(@1 IS NULL OR @1 = '' OR feedbackDate >= @1) " +
                "ORDER BY F.feedbackDate DESC";

    var custList = db.Query(sql, st, vd);
}

<h2 class="text-center bg-light p-2 mt-2">W11/Index</h2>

<form method="post" class="row mb-3">
    <div class="col-3">
        <input type="text" name="searchText" maxlength="100"
               placeholder="Customer Name"
               title="Enter a customer name"
               class="form-control"
               value="@st" />
    </div>
    <div class="col-3">
        <input type="date" name="visitDate" title="Select customer visit date"
               class="form-control" value="@vd" />
    </div>
    <div class="col-3">
        <button type="submit" class="btn btn-outline-info">Search</button>
    </div>
</form>

<div class="row">
    @foreach (var c in custList)
    {
        <div class="col-3 mb-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">@c.name</h5>
                    <p class="card-text">@c.email</p>
                    <p class="card-text">@c.feedbackDate.ToLongDateString()</p>
                    <a href="/W11/Details?cid=@c.customerID&fid=@c.feedbackID" class="float-end btn btn-primary">View Feedback</a>
                </div>
            </div>
        </div>
    }
</div>
```

- When you call `var db = DataBase.Open()`, it will actually navigate to Web.config file and read `<connectionStrings>`

```CS
<!-- Web.config  -->
<connectionStrings>
    <add name="FeedbackDB" connectionString="Data Source=(LocalDB)\MSSQLLocalDB;AttachDbFilename=|DataDirectory|\Feedback.mdf;Integrated Security=True;" providerName="System.Data.SqlClient" />
</connectionStrings>
```

- Always add a space at the end of each SQL line segment when using concatenation: `"SELECT * FROM Customers AS C "`
- First load, `vd` -> NULL; Second load, `vd` -> '';

### Part2

```CS
@using WebMatrix.Data

@{
    ViewBag.Title = "W11/Details";
}

@{
    var db = Database.Open("FeedbackDB");
    var custID = Request.QueryString["cid"];
    var feedID = Request.QueryString["fid"];

    var fSql = "SELECT * FROM Customers AS C " +
               "JOIN Feedback AS F ON C.customerID = F.customerID " +
               "WHERE F.feedbackID = @0";

    var catSql = "SELECT * FROM Categories AS C " +
                 "LEFT JOIN Ratings AS R ON C.categoryID = R.categoryID " +
                 "WHERE R.feedbackID = @0";

    var fRecord = db.QuerySingle(fSql, feedID);
    var catList = db.Query(catSql, feedID);
}

<h2>W11/Details</h2>
```

- Use `Request.QueryString` to get these requests from Post Method

## Change Database Record

### Creating Database Record

- `if (IsPost)`, checks if the request method is POST. Only true when the form is submitted.
- `GetLastInsertId()` returns the new IDENTITY ID which can be used to select the new record!

```CS
if (IsPost)
{
    var inSql = "INSERT INTO Episodes (episodeNo, seasonNo, title) " +
                "VALUES (@0, @1, @2)";

    var episodeNo = Request.Form["episodeNo"];
    var seasonNo = Request.Form["seasonNo"];
    var title = Request.Form["title"];

    db.Execute(inSql, episodeNo, seasonNo, title);

    var newID = db.GetLastInsertId();

    if (newID > 0)
    {
        Response.Redirect("/W12/Details?id=" + newID);
    }
}
```

#### Cleaner Version

- `SELECT SCOPE_IDENTITY()`, immediately returns the ID (auto-incremented primary key) of that newly inserted row

```CS
@{
    if (IsPost) {
        // SQL query to insert new episode and return its auto-generated ID
        var inSql = @"INSERT INTO Episodes (episodeNo, seasonNo, title)
                      VALUES (@0, @1, @2);
                      SELECT SCOPE_IDENTITY()";  // Retrieves the last identity value created

        // Execute query with parameters from form submission
        var iData = db.QueryValue(
            inSql,
            Request.Form["episodeNo"],  // First parameter (@0)
            Request.Form["seasonNo"],   // Second parameter (@1)
            Request.Form["title"]       // Third parameter (@2)
        );

        // Redirect to details page if insert succeeded
        if(iData > 0) {
            Response.Redirect("/W12/Details?id=" + iData);
        }
    }
}

<form method="post" action="/W12/Create">
    <!-- Missing in original snippet - should be added for full functionality -->
    <input type="number" name="seasonNo" required placeholder="Season Number">
    <input type="number" name="episodeNo" required placeholder="Episode Number">
    
    <input type="text" name="title" required placeholder="Title">
    <button type="submit">Save</button>
</form>
```

### Editing & Deleting Database Record

#### Editing

```CS
@if (IsPost)
{
    var uSql = "UPDATE Episodes SET seasonNo = @0, title = @1 WHERE episodeID = @2";

    var uData = db.Execute(uSql,
        Request.Form["seasonNo"],
        Request.Form["title"],
        Request.Form["id"]);

    if (uData == 1)
    {
        <div class="alert alert-success">Excellent</div>
    }
}

// Always executed to retrieve episode data
var sql = "SELECT * FROM Episodes WHERE episodeID = @0";
var data = db.QuerySingle(sql, Request.QueryString["id"]);
```

#### Deleting

```CS
@if (IsPost)
{
    var dSql = "DELETE FROM Episodes WHERE episodeID = @0";
    var dData = db.Execute(dSql, Request.Form["delete"]);

    if (dData == 1)
    {
        <div class="alert warning">Record Deleted!</div>
    }
}

// Always retrieve all episode data
var sql = "SELECT * FROM Episodes";
var data = db.Query(sql);
```
