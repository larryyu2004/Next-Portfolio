# Frontend Engineering

## Modularity

- node CommonJS (CJS)
- Ecmasript Module (ESM)

## Package Management

- npm
- pnpm
- yarn

## JS Tool Chain

### API Compatibility

#### Polyfill: core-js

- If we run this in node (v.10), it will say 'flatMap is not a function'

```JS
const result = [1, 2].flatMap((x) => [x, x * 2]);
console.log(result);
```

So we can write a function to implement it (but it will waste time).

```JS
Array.prototype.flatMap = function ...

const result = [1, 2].flatMap((x) => [x, x * 2]);
console.log(result);
```

So we can install core-js: `npm i core-js`

```JS
require("core-js/modules/es.array.flat-map.js");

const result = [1, 2].flatMap((x) => [x, x * 2]);
console.log(result);
```

### Syntax Compatibility

- If we run this in ES5, it will geneate an error, because ES5 cannot support `async` and `await`

```JS
// source.js
async function test() {
  return await Promise.resolve(1);
}

(async () => {
  const r = await test();
  console.log(r);
})();
```

So we need to install `npm i regenerator`

```JS
const regenerator = require('regenerator');
const fs = require('fs');
const path = require('path');

const sourcePath = path.resolve(__dirname, './source.js');
const source = fs.readFileSync(sourcePath, 'utf-8');

const result = regenerator.compile(source, {
  includeRuntime: true,
});

const targetPath = path.resolve(__dirname, './target.js');
// Generate a runnable code and paste it to another file
fs.writeFileSync(targetPath, result.code, 'utf-8');
console.log('compile success!');

```

- Now it will have a target file without any `async` and `await`

### Language Enhancement

- In some low version of JS, we cannot execute this:

```JS
const obj = {};

obj?.foo?.bar?.baz; // undefined

const result = [1, 2].flatMap((x) => [x, x * 2]);
console.log(result);

```

- Install babel `npm i -D @babel/core @babel/cli`
- Then we install `npm i -D @babel/plugin-transform-optional-channing`
- Then config babel:

```JS
// babel.config.js
module.exports = {
  presets: [
    [
      '@babel/preset-env',
      {
        targets: {
          edge: '17',
          firefox: '60',
          chrome: '67',
          safari: '11.1',
        },
        useBuiltIns: 'usage',
        corejs: '3.32.2',
      },
    ],
  ],

};

```

- Here, we already changed the script

```JSON
"scripts": {
    "compile": "babel babel/source.js -o babel/target.js"
}
```

- Then run `npm run compile`
- It will generate a new target:

```JS
"use strict";

require("core-js/modules/es.array.flat-map.js");
require("core-js/modules/es.array.unscopables.flat-map.js");
var _obj$foo;
const obj = {};
obj === null || obj === void 0 || (_obj$foo = obj.foo) === null || _obj$foo === void 0 || (_obj$foo = _obj$foo.bar) === null || _obj$foo === void 0 || _obj$foo.baz; // undefined

const result = [1, 2].flatMap(x => [x, x * 2]);
console.log(result);

```

## CSS Tool Chain
- Lack of Syntax (Loop, Judge, Splice)
- Lack of Feature (Color Function, Math Function, Customised Function)
### Precomplier
- sass
- less
- stylus
### sass
- Download sass `npm i -g sass`;
- Convert a.sass to CSS code named a.css using command `sass a.sass a.css`, this step will generate 2 files, a.css and a.css.map, so we can use `sass a.sass a.css --no-source-map` to prevent generating a.css.map.
- Automatically Update: `sass a.sass a.css --no-source-map -w`, it will return `Sass is watching for changes. Press Ctrl-C to stop`, which means once the a.sass changes, the a.css will change as well.
```sass
@function createShadow($n) {
  $shadow: '#{random(100)}vw #{random(100)}vh #fff';
  @for $i from 2 through $n {
    $shadow: '#{$shadow}, #{random(100)}vw #{random(100)}vh #fff';
  }
  @return unquote($shadow);
}
$count: 1000;
$duration: 400s;
@for $i from 1 through 3 {
  $count: floor(calc($count / 2));
  $duration: floor(calc($duration / 2));

  @debug 'count: #{$count}';
  @debug 'duration: #{$duration}';
  .layer#{$i} {
    $size: #{$i}px;
    position: fixed;
    width: $size;
    height: $size;
    border-radius: 50%; 
    left: 0;
    top: 0;
    box-shadow: createShadow($count);
    animation: moveUp $duration linear infinite;
    &::after {
      content: '';
      position: fixed;
      left: 0;
      top: 100vh;
      width: inherit;
      height: inherit;
      border-radius: inherit;
      box-shadow: inherit;
    }
  }
}

```

### PostCSS

#### The Architecture of PostCSS
-  CSS -> Parser -> Plugin 1 -> Plugin 2 -> ... -> Stringifier -> New CSS


### Webpack
- `entry: './src/main.js'` is the entry of the project, Webpack will analysis the import for each file and generate AST (Abstract Syntax Tree). Webpack can deal both ESM (`import` -> Browser supports) and CMJ (`reuqire` -> Browser doesn't support).
- If we enter `webpack serve` in the terminal, it will create a port and packing the file while you are coding (similar to Live Serve).
```JS
const path = require('path');
const HtmlWebpackPlugin = require('html-webpack-plugin');
const MiniCssExtractPlugin = require('mini-css-extract-plugin');
const CopyPlugin = require('copy-webpack-plugin');

module.exports = {
  mode: 'development',
  entry: './src/main.js',
  output: {
    path: path.resolve(__dirname, './dist'),
    filename: 'js/app-[contenthash:5].js', // Output JavaScript filename with a 5-character content hash
    assetModuleFilename: 'assets/[hash:5][ext]', // Output filename format for assets
    chunkFilename: 'js/chunk-[contenthash:5].js', // Filename format for dynamic imported chunks
    // publicPath: './', // Optional: set base path for all assets
    clean: true, // Clean the output directory before each build
  },
  target: 'web',
  devtool: 'source-map', // Generate source maps for debugging
  devServer: {
    port: 8080, // Development server port
    // static: './dist', // Optional: serve static files from 'dist' folder
    proxy: {
      '/api': {
        // Proxy requests starting with /api to another server
        target: 'https://study.duyiedu.com', // Target server to proxy to
        changeOrigin: true, // Change the origin header to the target URL
      },
    },
  },
  resolve: {
    alias: {
      '@': path.resolve(__dirname, 'src'), // Use '@' as a shortcut to refer to the src directory
    },
  },
  stats: 'errors-only', // Only show errors in the terminal output
  module: {
    rules: [
      {
        test: /\.(css|less)$/i,
        use: [
          MiniCssExtractPlugin.loader, // Extract CSS into separate files
          'css-loader', // Interpret @import and url()
          'postcss-loader', // Process CSS with PostCSS
          'less-loader', // Compile Less to CSS
        ],
      },
      {
        test: /\.(mp3|mp4)$/, // Handle audio and video files
        type: 'asset/resource',
      },
      {
        test: /\.(gif|png|webp|svg|jpg|jpeg|bmp)$/, // Handle image files
        type: 'asset',
        parser: {
          dataUrlCondition: {
            maxSize: 1024, // Inline files smaller than 1KB as Base64
          },
        },
      },
      {
        test: /\.js$/, // Transpile JavaScript files
        exclude: /node_modules/, // Exclude node_modules from transpilation
        use: 'babel-loader',
      },
    ],
  },
  plugins: [
    new HtmlWebpackPlugin({
      template: path.resolve(__dirname, 'public/index.html'), // Template HTML file
    }),
    new MiniCssExtractPlugin({
      filename: 'css/[name]-[contenthash:5].css', // Extracted CSS filename with content hash
    }),
    new CopyPlugin({
      // Use the copy plugin to copy static files
      patterns: [
        {
          from: path.resolve(__dirname, 'public'), // Source folder
          to: './', // Destination folder (root of dist)
          globOptions: {
            ignore: ['**/*.html'], // Ignore HTML files when copying
          },
        },
      ],
    }),
  ],
};
```

#### File Fingerprint
- In each pack, Webpack will send these JS and CSS files to browser with some fingerprints, browser will push these files into cache. If Webpack updates these files, and send to browser, browser will update these files based on the file fingerprint, checking if they are same -> no updates, use cache; new update, get new file.

### Scaffold
- vue-cli; vite; cra (React)
- Install vite `npm create vite@lastest`

